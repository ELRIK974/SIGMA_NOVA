<div id="stockPage">
  <h1 class="mb-4">
    <i class="fas fa-warehouse me-2"></i>
    État des stocks
  </h1>
  
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-boxes me-2"></i> Inventaire</span>
          <div>
            <button type="button" class="btn btn-success btn-sm me-2" id="btnNouvelArticle">
              <i class="fas fa-plus me-1"></i> Nouvel article
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="btnExportStock">
              <i class="fas fa-file-export me-1"></i> Exporter
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" placeholder="Rechercher un article..." id="searchStock">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Filtrer</button>
              <ul class="dropdown-menu dropdown-menu-end" id="stockFilterDropdown">
                <li><a class="dropdown-item active" href="#" data-filter="Tous">Tous</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Consommable">Consommables</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Non consommable">Non consommables</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Stock critique">Stock critique</a></li>
                <!-- Autres filtres ajoutés dynamiquement -->
              </ul>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="stockTable">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Catégorie</th>
                  <th>Quantité</th>
                  <th>Seuil alerte</th>
                  <th>Localisation</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Sera rempli dynamiquement -->
                <tr>
                  <td colspan="6" class="text-center">Chargement des données...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <nav aria-label="Pagination des articles">
            <ul class="pagination justify-content-center" id="stockPagination">
              <!-- Sera rempli dynamiquement -->
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Inclure le formulaire d'ajout/modification -->
  <?!= include('stockItemForm'); ?>

  <!-- Modal de confirmation de suppression -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmer la suppression</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p>Êtes-vous sûr de vouloir supprimer cet article ?</p>
          <p class="text-danger"><strong>Cette action est irréversible.</strong></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales pour la page Stock
    let currentPage = 1;
    let pageSize = 10;
    let currentFilter = 'Tous';
    let currentSearch = '';
    let itemToDelete = null;
    
    // Initialisation de la page Stock
    function initializeStockPage() {
      console.log('Initialisation de la page Stock');
      
      // Chargement initial des données
      loadStockData();
      
      // Configuration des gestionnaires d'événements
      setupStockEventHandlers();
    }
    
    // Chargement des données du stock
    function loadStockData() {
      showSpinner();
      
      google.script.run
        .withSuccessHandler(function(data) {
          // Remplir le tableau avec les articles
          fillStockTable(data.stockData.items);
          
          // Mettre à jour la pagination
          updatePagination(data.stockData.pagination);
          
          // Remplir les filtres de catégorie
          fillCategoryFilters(data.categories);
          
          // Remplir la liste des localisations
          fillLocationsList(data.locations);
          
          hideSpinner();
        })
        .withFailureHandler(function(error) {
          console.error('Erreur lors du chargement des données de stock:', error);
          hideSpinner();
          showErrorMessage('Erreur lors du chargement des données de stock');
        })
        .getStockPageData(currentPage, pageSize, currentFilter, currentSearch);
    }
    
    // Configuration des gestionnaires d'événements pour la page Stock
    function setupStockEventHandlers() {
      // Événement pour la recherche
      document.getElementById('searchStock').addEventListener('input', function() {
        currentSearch = this.value;
        currentPage = 1; // Retourner à la première page lors d'une recherche
        loadStockData();
      });
      
      // Événement pour le filtre de catégorie
      document.getElementById('stockFilterDropdown').addEventListener('click', function(e) {
        if (e.target.classList.contains('dropdown-item')) {
          e.preventDefault();
          
          // Mettre à jour le filtre actif visuellement
          document.querySelectorAll('#stockFilterDropdown .dropdown-item').forEach(item => {
            item.classList.remove('active');
          });
          e.target.classList.add('active');
          
          // Appliquer le filtre
          currentFilter = e.target.getAttribute('data-filter');
          currentPage = 1; // Retourner à la première page lors d'un filtrage
          loadStockData();
        }
      });
      
      // Événement pour le bouton Nouvel article
      document.getElementById('btnNouvelArticle').addEventListener('click', function() {
        openStockItemForm();
      });
      
      // Événement pour le bouton Exporter
      document.getElementById('btnExportStock').addEventListener('click', function() {
        exportStockToCSV();
      });
      
      // Événement pour le bouton Enregistrer dans le formulaire
      document.getElementById('saveStockItem').addEventListener('click', function() {
        saveStockItemForm();
      });
      
      // Événement pour le bouton Confirmer la suppression
      document.getElementById('confirmDelete').addEventListener('click', function() {
        if (itemToDelete) {
          deleteStockItem(itemToDelete);
        }
      });
    }
    
    // Remplir le tableau avec les articles
    function fillStockTable(items) {
      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = '';
      
      if (items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="6" class="text-center">Aucun article trouvé</td>`;
        tbody.appendChild(row);
        return;
      }
      
      items.forEach(item => {
        const row = document.createElement('tr');
        
        // Ajouter une classe si le stock est critique
        if (Number(item.Quantité) <= Number(item["Seuil alerte"])) {
          row.classList.add('table-warning');
        }
        
        row.innerHTML = `
          <td>${item.Nom}</td>
          <td>${item.Catégorie || ''}</td>
          <td>${item.Quantité}</td>
          <td>${item["Seuil alerte"]}</td>
          <td>${item.Localisation || ''}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1 btn-edit" data-id="${item.ID}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${item.ID}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
      
      // Ajouter les gestionnaires d'événements pour les boutons d'action
      document.querySelectorAll('#stockTable .btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
          const itemId = this.getAttribute('data-id');
          editStockItem(itemId);
        });
      });
      
      document.querySelectorAll('#stockTable .btn-delete').forEach(btn => {
        btn.addEventListener('click', function() {
          const itemId = this.getAttribute('data-id');
          confirmDeleteItem(itemId);
        });
      });
    }
    
    // Mettre à jour la pagination
    function updatePagination(pagination) {
      const paginationEl = document.getElementById('stockPagination');
      paginationEl.innerHTML = '';
      
      // Bouton Précédent
      const prevItem = document.createElement('li');
      prevItem.className = `page-item ${pagination.currentPage === 1 ? 'disabled' : ''}`;
      prevItem.innerHTML = `<a class="page-link" href="#" data-page="${pagination.currentPage - 1}">Précédent</a>`;
      paginationEl.appendChild(prevItem);
      
      // Pages numérotées
      for (let i = 1; i <= pagination.totalPages; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = `page-item ${i === pagination.currentPage ? 'active' : ''}`;
        pageItem.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        paginationEl.appendChild(pageItem);
      }
      
      // Bouton Suivant
      const nextItem = document.createElement('li');
      nextItem.className = `page-item ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}`;
      nextItem.innerHTML = `<a class="page-link" href="#" data-page="${pagination.currentPage + 1}">Suivant</a>`;
      paginationEl.appendChild(nextItem);
      
      // Ajouter les gestionnaires d'événements pour les liens de pagination
      document.querySelectorAll('#stockPagination .page-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          if (!this.parentElement.classList.contains('disabled')) {
            currentPage = parseInt(this.getAttribute('data-page'));
            loadStockData();
          }
        });
      });
    }
    
    // Remplir les filtres de catégorie
    function fillCategoryFilters(categories) {
      const dropdown = document.getElementById('stockFilterDropdown');
      
      // Conserver les items par défaut (Tous, Consommables, Non consommables, Stock critique)
      const defaultItems = Array.from(dropdown.querySelectorAll('li')).slice(0, 4);
      
      // Vider le dropdown
      dropdown.innerHTML = '';
      
      // Restaurer les items par défaut
      defaultItems.forEach(item => {
        dropdown.appendChild(item);
      });
      
      // Ajouter les catégories personnalisées
      categories.forEach(category => {
        if (category !== 'Consommable' && category !== 'Non consommable') {
          const item = document.createElement('li');
          item.innerHTML = `<a class="dropdown-item" href="#" data-filter="${category}">${category}</a>`;
          dropdown.appendChild(item);
        }
      });
    }
    
    // Remplir la liste des localisations pour l'autocomplétion
    function fillLocationsList(locations) {
      const datalist = document.getElementById('locationsList');
      datalist.innerHTML = '';
      
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        datalist.appendChild(option);
      });
    }
    
    // Ouvrir le formulaire d'article (pour création ou édition)
    function openStockItemForm(itemData = null) {
      // Réinitialiser le formulaire
      document.getElementById('stockItemForm').reset();
      document.getElementById('stockItemId').value = '';
      
      if (itemData) {
        // Mode édition
        document.getElementById('stockItemModalLabel').textContent = 'Modifier un article';
        document.getElementById('stockItemId').value = itemData.ID;
        document.getElementById('stockItemName').value = itemData.Nom || '';
        document.getElementById('stockItemCategory').value = itemData.Catégorie || '';
        document.getElementById('stockItemQuantity').value = itemData.Quantité || 0;
        document.getElementById('stockItemThreshold').value = itemData["Seuil alerte"] || 0;
        document.getElementById('stockItemLocation').value = itemData.Localisation || '';
        document.getElementById('stockItemSupplierRef').value = itemData["Référence fournisseur"] || '';
        document.getElementById('stockItemSupplierLink').value = itemData["Lien fournisseur"] || '';
      } else {
        // Mode création
        document.getElementById('stockItemModalLabel').textContent = 'Nouvel article';
      }
      
      // Afficher le modal
      const modal = new bootstrap.Modal(document.getElementById('stockItemModal'));
      modal.show();
    }
    
    // Éditer un article existant
    function editStockItem(itemId) {
      showSpinner();
      
      google.script.run
        .withSuccessHandler(function(itemData) {
          hideSpinner();
          if (itemData) {
            openStockItemForm(itemData);
          } else {
            showErrorMessage('Article non trouvé');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Erreur lors de la récupération des données de l\'article:', error);
          hideSpinner();
          showErrorMessage('Erreur lors de la récupération des données de l\'article');
        })
        .getStockItemForEdit(itemId);
    }
    
    // Sauvegarder les données du formulaire
    function saveStockItemForm() {
      // Valider le formulaire
      const form = document.getElementById('stockItemForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Récupérer les données du formulaire
      const itemData = {
        ID: document.getElementById('stockItemId').value,
        Nom: document.getElementById('stockItemName').value,
        Catégorie: document.getElementById('stockItemCategory').value,
        Quantité: document.getElementById('stockItemQuantity').value,
        "Seuil alerte": document.getElementById('stockItemThreshold').value,
        Localisation: document.getElementById('stockItemLocation').value,
        "Référence fournisseur": document.getElementById('stockItemSupplierRef').value,
        "Lien fournisseur": document.getElementById('stockItemSupplierLink').value
      };
      
      showSpinner();
      
      google.script.run
        .withSuccessHandler(function(result) {
          hideSpinner();
          
          // Fermer le modal
          bootstrap.Modal.getInstance(document.getElementById('stockItemModal')).hide();
          
          // Recharger les données
          loadStockData();
        })
        .withFailureHandler(function(error) {
          console.error('Erreur lors de l\'enregistrement de l\'article:', error);
          hideSpinner();
          showErrorMessage('Erreur lors de l\'enregistrement de l\'article');
        })
        .saveStockItem(itemData);
    }
    
    // Confirmer la suppression d'un article
    function confirmDeleteItem(itemId) {
      itemToDelete = itemId;
      const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
      modal.show();
    }
    
    // Supprimer un article
    function deleteStockItem(itemId) {
      showSpinner();
      
      google.script.run
        .withSuccessHandler(function(result) {
          hideSpinner();
          
          // Fermer le modal de confirmation
          bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
          
          // Réinitialiser l'ID de l'article à supprimer
          itemToDelete = null;
          
          // Recharger les données
          loadStockData();
        })
        .withFailureHandler(function(error) {
          console.error('Erreur lors de la suppression de l\'article:', error);
          hideSpinner();
          showErrorMessage('Erreur lors de la suppression de l\'article');
        })
        .deleteStockItemFromUI(itemId);
    }
    
    // Exporter les données du stock au format CSV
    function exportStockToCSV() {
      showSpinner();
      
      google.script.run
        .withSuccessHandler(function(csvContent) {
          hideSpinner();
          
          // Création d'un élément <a> temporaire pour le téléchargement
          const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
          const link = document.createElement('a');
          link.setAttribute('href', encodedUri);
          link.setAttribute('download', 'SIGMA_Stock_Export_' + new Date().toISOString().split('T')[0] + '.csv');
          document.body.appendChild(link);
          
          // Cliquer automatiquement sur le lien pour démarrer le téléchargement
          link.click();
          
          // Supprimer l'élément
          document.body.removeChild(link);
        })
        .withFailureHandler(function(error) {
          console.error('Erreur lors de l\'exportation des données:', error);
          hideSpinner();
          showErrorMessage('Erreur lors de l\'exportation des données');
        })
        .getStockCSVExport();
    }
  </script>
</div>
